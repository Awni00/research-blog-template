---
import { Font } from "astro:assets";

import Links from "../components/Links.astro";
import Authors from "../components/Authors.astro";
import Notes from "../components/Notes.astro";
import ThemeToggle from "../components/ThemeToggle";
import HomeLinkHeader from "../components/HomeLinkHeader.astro";
import type { Author, Note, Link } from "../types/types";

import "../styles/global.css";
import "katex/dist/katex-swap.css";

interface Props {
  frontmatter: {
    title: string;
    authors: Author[];
    conference?: string;
    notes?: Note[];
    links?: Link[];
    description?: string;
    favicon: string;
    thumbnail?: string;
    homeLink?: {
      link: string;
      title?: string;
      icon?: string;
      newTab?: boolean;
    };
    theme?: "device" | "light" | "dark";
  };
}

const {
  title,
  description,
  favicon,
  thumbnail,
  authors,
  conference,
  notes,
  links,
  theme = "device",
  homeLink,
} = Astro.props.frontmatter;
const baseUrl = import.meta.env.BASE_URL;
const prefix = baseUrl.endsWith("/") ? baseUrl : baseUrl + "/";
---

<!doctype html>
<html
  lang="en"
  data-theme={theme}
  /* Keep Tailwind dark variant in sync with the chosen theme */
  class={theme === "dark" ? "dark" : undefined}
>
  <head>
    {/* Basic document metadata */}
    <meta charset="UTF-8" />
    {/* Optional front-matter metadata */}
    {description && <meta name="description" content={description} />}
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />

    <link rel="icon" type="image/svg+xml" href={prefix + favicon} />

    {/* Social sharing previews */}
    <meta property="og:title" content={title} />
    {description && <meta property="og:description" content={description} />}
    <meta property="og:type" content="website" />
    {thumbnail && <meta property="og:image" content={prefix + thumbnail} />}

    <Font cssVariable="--font-noto-sans" preload />

    <title>{title}</title>
  </head>
  <body
    class="font-(family-name:--font-noto-sans) prose prose-lg prose-zinc dark:prose-invert prose-a:text-blue-500 prose-a:dark:text-blue-300 prose-a:no-underline prose-a:hover:underline prose-a:font-normal prose-code:bg-zinc-200 prose-code:dark:bg-zinc-800 prose-code:text-zinc-800 prose-code:dark:text-zinc-200 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:font-medium prose-code:before:content-none prose-code:after:content-none mx-auto max-w-[50rem] bg-white px-6 pt-16 pb-6 dark:bg-zinc-900"
  >
    <header>
      <div class="mb-8 flex items-center justify-between gap-4">
        <div class="flex flex-1 items-center">
          {homeLink?.link && <HomeLinkHeader {...homeLink} />}
        </div>
        {/* Theme switcher respects front-matter default */}
        <ThemeToggle
          client:load
          initialTheme={theme}
          className="flex items-center justify-end"
        />
      </div>
      <h1 class="text-center text-5xl font-medium">{title}</h1>
      <div class="flex flex-col items-center gap-6">
        <Authors authors={authors} />
        {conference && <div>{conference}</div>}
        {notes && <Notes notes={notes} />}
        {links && <Links links={links} />}
      </div>
    </header>
    <main>
      <slot />
    </main>
    <footer class="flex w-full justify-center">
      <p class="prose-sm text-center">
        {/* Template attribution required by upstream project */}
        This page was built using the template at <a
          href="https://github.com/Awni00/research-blog-template"
          >Awni00/research-blog-template</a
        >, which builds on the templates of <a href="https://github.com/RomanHauksson/academic-project-astro-template"
          >RomanHauksson/academic-project-astro-template</a
        > and <a href="https://github.com/nerfies/nerfies.github.io"
          >Nerfies/nerfies.github.io</a>. <br> This template is licensed
        under <a href="http://creativecommons.org/licenses/by-sa/4.0/"
          >CC BY-SA 4.0</a
        >.
      </p>
    </footer>
  </body>
  <script is:inline>
    // Set up hover previews for MDX footnote references.
    document.addEventListener("DOMContentLoaded", () => {
      const footnoteRefs = document.querySelectorAll("a[data-footnote-ref]");
      if (!footnoteRefs.length) return;

      const footnoteItems = document.querySelectorAll(
        "section[data-footnotes] li[id]",
      );
      if (!footnoteItems.length) return;

      const footnoteLookup = new Map();
      footnoteItems.forEach((item) => {
        const clone = item.cloneNode(true);
        clone.querySelectorAll("[data-footnote-backref]").forEach((link) => {
          link.remove();
        });
        footnoteLookup.set(item.id, clone.innerHTML.trim());
      });

      const tooltip = document.createElement("div");
      tooltip.className = "footnote-preview";
      tooltip.setAttribute("role", "tooltip");
      tooltip.setAttribute("data-visible", "false");
      document.body.appendChild(tooltip);

      let activeRef = null;
      const offset = 10;

      const updatePosition = () => {
        if (!activeRef) return;
        const rect = activeRef.getBoundingClientRect();
        tooltip.style.left = "0px";
        tooltip.style.top = "0px";

        const tooltipRect = tooltip.getBoundingClientRect();
        let top = rect.bottom + window.scrollY + offset;
        let left =
          rect.left +
          window.scrollX +
          rect.width / 2 -
          tooltipRect.width / 2;

        const minLeft = window.scrollX + 12;
        const maxLeft =
          window.scrollX + window.innerWidth - tooltipRect.width - 12;
        if (left < minLeft) left = minLeft;
        if (left > maxLeft) left = maxLeft;

        if (
          top + tooltipRect.height >
          window.scrollY + window.innerHeight - 12
        ) {
          top = rect.top + window.scrollY - tooltipRect.height - offset;
        }

        tooltip.style.left = `${left}px`;
        tooltip.style.top = `${top}px`;
      };

      const hideTooltip = () => {
        tooltip.setAttribute("data-visible", "false");
        tooltip.style.left = "-9999px";
        tooltip.style.top = "-9999px";
        activeRef = null;
        window.removeEventListener("scroll", updatePosition, true);
        window.removeEventListener("resize", updatePosition);
      };

      const showTooltip = (ref) => {
        const href = ref.getAttribute("href");
        if (!href || !href.startsWith("#")) return;

        const id = href.slice(1);
        const html = footnoteLookup.get(id);
        if (!html) return;

        tooltip.innerHTML = html;
        if (activeRef !== ref) {
          activeRef = ref;
          tooltip.setAttribute("data-visible", "true");
          requestAnimationFrame(() => {
            if (activeRef === ref) {
              updatePosition();
            }
          });
          window.addEventListener("scroll", updatePosition, true);
          window.addEventListener("resize", updatePosition);
        } else {
          updatePosition();
        }
      };

      footnoteRefs.forEach((ref) => {
        ref.addEventListener("mouseenter", () => showTooltip(ref));
        ref.addEventListener("mouseleave", hideTooltip);
        ref.addEventListener("focus", () => showTooltip(ref));
        ref.addEventListener("blur", hideTooltip);
        ref.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            hideTooltip();
          }
        });
      });
    });
  </script>
</html>
